<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ROLETAS PREMIADAS</title>
    
    <meta name="description" content="Filantropia premiável.">
    <meta name="robots" content="index, follow">

    <meta property="og:title" content="ROLETAS PREMIADAS">
    <meta property="og:image" content="/public/images/principal.jpg">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" type="text/css" href="/public/css/main.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        body { background-color: #161c24; color: #fff; font-family: 'Roboto', sans-serif; }
        body.modal-travado { overflow:hidden !important; }
        #pageHome.is-hidden { display:none !important; }

        /* Modais */
        .ck-overlay, #ckPix, #ckLoading {
            position: fixed; inset: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,.85); z-index: 99999; display: none;
            justify-content: center; align-items: center;
        }
        .ck-overlay.is-open, #ckPix.is-open, #ckLoading.is-open { display: flex; }

        /* Card Central */
        .ck-card {
            background: #1a2330; width: 90%; max-width: 500px;
            border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);
            overflow: hidden; position: relative;
        }
        .ck-header {
            padding: 15px; background: #151c26; border-bottom: 1px solid rgba(255,255,255,0.05);
            display: flex; justify-content: space-between; align-items: center; font-weight: bold;
        }
        .ck-body { padding: 20px; }
        
        /* Inputs */
        .ck-row {
            background: #0f1722; border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px; margin-bottom: 10px; display: flex; align-items: center;
        }
        .ck-input {
            width: 100%; background: transparent; border: none; color: #fff;
            padding: 12px; outline: none;
        }
        .ck-label { font-size: 12px; color: #aaa; margin-bottom: 5px; margin-top: 10px; }
        
        /* Botões */
        .ck-btn {
            width: 100%; background: #ff3b3b; color: #fff; border: none;
            padding: 15px; border-radius: 8px; font-weight: bold; margin-top: 20px; cursor: pointer;
        }
        .ck-close { cursor: pointer; font-size: 20px; }

        /* Loading */
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #ff3b3b; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Estilos do Site (Simplificado) */
        .container { max-width: 600px; margin: 0 auto; padding: 0; }
        .img-single { width: 100%; height: 250px; background-size: cover; background-position: center; }
        .background-gradient { padding: 15px; background: linear-gradient(to bottom, #1f2832, #161c24); }
        .select-single { padding: 15px; }
        .content-select { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .select { background: #000; padding: 10px; text-align: center; border-radius: 8px; cursor: pointer; border: 1px solid #333; }
        .select:hover { border-color: #ff3b3b; }
        .add-to-cart { background: #1f2832; padding: 15px; border-radius: 12px; margin-top: 10px; }
        .quantity-input { display: flex; justify-content: space-between; align-items: center; background: #0f1722; padding: 10px; border-radius: 8px; margin-bottom: 10px; }
        .btn-add-to-cart { width: 100%; background: #28a745; color: #fff; border: none; padding: 15px; border-radius: 8px; font-weight: bold; font-size: 18px; }
        
        /* PIX Screen */
        .pix-code-box { background: #0f1722; padding: 10px; border-radius: 8px; word-break: break-all; font-size: 12px; font-family: monospace; margin: 10px 0; border: 1px dashed #555; }
        .pix-copy-btn { background: #ff3b3b; color: #fff; border: none; padding: 5px 15px; border-radius: 5px; font-size: 12px; margin-left: 10px; }
        #pixQrWrap { background: #fff; padding: 10px; display: inline-block; margin-top: 15px; border-radius: 8px; }
    </style>
</head>

<body>

<div id="pageHome">
    <nav style="background: #1a1a1a; padding: 15px; text-align: center;">
        <img src="/public/images/logo.png" style="height: 30px;">
    </nav>

    <div class="container">
        <div class="img-single" id="imgSingle" style="background-image: url('/public/images/principal.jpg');"></div>
        
        <div class="background-gradient">
            <h3>ROLETAS PREMIADAS</h3>
            <p style="color: #ccc;">Sua chance de mudar de vida!</p>
            <div style="background: #000; padding: 5px 10px; display: inline-block; border-radius: 5px;">
                Por apenas <strong>R$ 0,03</strong>
            </div>
        </div>

        <div class="select-single">
            <p>Selecione a quantidade:</p>
            <div class="content-select">
                <div class="select" onclick="setQty(100)">+100</div>
                <div class="select" onclick="setQty(350)" style="border-color: #ff3b3b;">+350 (Popular)</div>
                <div class="select" onclick="setQty(500)">+500</div>
                <div class="select" onclick="setQty(1000)">+1000</div>
                <div class="select" onclick="setQty(5000)">+5000</div>
                <div class="select" onclick="setQty(10000)">+10000</div>
            </div>

            <div class="add-to-cart">
                <div class="quantity-input">
                    <i class="bi bi-dash-circle" onclick="changeQty(-1)" style="font-size: 24px; cursor: pointer;"></i>
                    <input type="number" id="inputQty" value="100" style="background: transparent; border: none; color: #fff; text-align: center; font-size: 20px; width: 100px;">
                    <i class="bi bi-plus-circle-fill" onclick="changeQty(1)" style="font-size: 24px; cursor: pointer;"></i>
                </div>
                <button class="btn-add-to-cart" id="btnBuy">
                    PARTICIPAR <span id="btnPrice">R$ 3,00</span>
                </button>
            </div>
        </div>
    </div>
</div>

<div id="ckStep1" class="ck-overlay">
    <div class="ck-card">
        <div class="ck-header">Checkout <span class="ck-close" onclick="closeAll()">×</span></div>
        <div class="ck-body">
            <div class="ck-alert blue" style="background: #1e3a5f; padding: 10px; border-radius: 5px; margin-bottom: 15px; font-size: 13px;">
                Você está adquirindo <b id="lblQty">100</b> cotas.
            </div>
            
            <div class="ck-label">Seu Nome Completo</div>
            <div class="ck-row"><input type="text" id="ckName" class="ck-input" placeholder="Digite seu nome"></div>

            <div class="ck-label">Seu CPF (Apenas números)</div>
            <div class="ck-row"><input type="tel" id="ckCpf" class="ck-input" placeholder="000.000.000-00" maxlength="14"></div>

            <div class="ck-label">Seu E-mail</div>
            <div class="ck-row"><input type="email" id="ckEmail" class="ck-input" placeholder="seu@email.com"></div>

            <button class="ck-btn" id="btnPay">GERAR PIX</button>
        </div>
    </div>
</div>

<div id="ckLoading">
    <div class="ck-card" style="text-align: center; padding: 30px;">
        <div class="loader"></div>
        <p>Conectando com o servidor...</p>
        <p style="font-size: 12px; color: #aaa;">Isso pode levar alguns segundos.</p>
    </div>
</div>

<div id="ckPix">
    <div class="ck-card">
        <div class="ck-header">Pagamento PIX <span class="ck-close" onclick="closeAll()">×</span></div>
        <div class="ck-body" style="text-align: center;">
            <p style="font-size: 14px; color: #aaa;">Copie o código abaixo e pague no seu banco:</p>
            
            <div class="pix-code-box" style="display: flex; align-items: center; justify-content: space-between;">
                <span id="pixText" style="overflow: hidden; white-space: nowrap; text-overflow: ellipsis; max-width: 200px;">...</span>
                <button class="pix-copy-btn" onclick="copyPix()">COPIAR</button>
            </div>

            <div id="pixQrWrap"></div>
            
            <p style="margin-top: 15px; font-size: 12px; color: #aaa;">Após pagar, aguarde a confirmação automática.</p>
            
            <button class="ck-btn" style="background: #444;" onclick="closeAll()">FECHAR</button>
        </div>
    </div>
</div>

<script>
    // ==================================================
    // ⚠️ CONFIGURAÇÃO DA API ⚠️
    // Coloque sua chave secreta aqui dentro das aspas:
    const ABACASH_SECRET_KEY = "SUA_SECRET_KEY"; 
    // ==================================================

    const UNIT_PRICE = 0.03;
    let currentQty = 100;

    // --- Lógica de Quantidade e Preço ---
    function updatePrice() {
        const total = (currentQty * UNIT_PRICE).toFixed(2).replace('.', ',');
        document.getElementById('inputQty').value = currentQty;
        document.getElementById('btnPrice').innerText = `R$ ${total}`;
        document.getElementById('lblQty').innerText = currentQty;
    }

    function setQty(val) {
        currentQty = val;
        updatePrice();
    }

    function changeQty(amount) {
        currentQty += amount;
        if(currentQty < 1) currentQty = 1;
        updatePrice();
    }

    document.getElementById('inputQty').addEventListener('input', (e) => {
        let val = parseInt(e.target.value);
        if(val > 0) currentQty = val;
        updatePrice();
    });

    // --- Lógica de Modais ---
    function closeAll() {
        document.querySelectorAll('.ck-overlay, #ckPix, #ckLoading').forEach(el => el.classList.remove('is-open'));
        document.body.classList.remove('modal-travado');
    }

    // Botão "Quero Participar"
    document.getElementById('btnBuy').onclick = () => {
        document.getElementById('ckStep1').classList.add('is-open');
        document.body.classList.add('modal-travado');
    };

    // --- INTEGRAÇÃO API (Fetch baseado no seu código Node) ---
    document.getElementById('btnPay').onclick = async () => {
        const name = document.getElementById('ckName').value;
        const cpf = document.getElementById('ckCpf').value.replace(/\D/g, '');
        const email = document.getElementById('ckEmail').value;

        if(!name || !cpf || !email) {
            alert("Por favor, preencha todos os campos!");
            return;
        }

        // Fecha checkout e abre loading
        document.getElementById('ckStep1').classList.remove('is-open');
        document.getElementById('ckLoading').classList.add('is-open');

        const amountVal = parseFloat((currentQty * UNIT_PRICE).toFixed(2));

        try {
            // AQUI ESTÁ A LÓGICA DO SEU NODE.JS CONVERTIDA PARA FETCH
            const response = await fetch('https://app.abacash.com/api/payment.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${ABACASH_SECRET_KEY}`
                },
                body: JSON.stringify({
                    action: "create",
                    product_id: "prod_123456", // Ajuste se necessário
                    amount: amountVal,
                    customer: {
                        name: name,
                        cpf: cpf,
                        email: email
                    }
                })
            });

            const data = await response.json();
            
            // Debug no console para você ver o retorno real
            console.log("Retorno da API:", data);

            // Verifica se deu erro
            if (!response.ok || data.error) {
                throw new Error(data.message || "Erro na criação do PIX");
            }

            // Pega o código PIX do retorno (ajuste o campo conforme o retorno real)
            // Geralmente vem em 'pix_copy_paste', 'qrcode', ou 'payment_code'
            const pixCode = data.pix_copy_paste || data.qrcode || data.pix || "Erro: Código PIX não encontrado no retorno";

            showPixScreen(pixCode);

        } catch (error) {
            console.error("Erro na requisição:", error);
            document.getElementById('ckLoading').classList.remove('is-open');
            alert("Erro ao gerar PIX: " + error.message);
            document.getElementById('ckStep1').classList.add('is-open'); // Volta pro form
        }
    };

    function showPixScreen(code) {
        document.getElementById('ckLoading').classList.remove('is-open');
        document.getElementById('ckPix').classList.add('is-open');
        
        // Preenche o código
        document.getElementById('pixText').innerText = code;
        
        // Gera o QR Code visual
        const qrBox = document.getElementById('pixQrWrap');
        qrBox.innerHTML = '';
        new QRCode(qrBox, {
            text: code,
            width: 200,
            height: 200
        });
    }

    function copyPix() {
        const text = document.getElementById('pixText').innerText;
        navigator.clipboard.writeText(text);
        alert("Código PIX copiado!");
    }

    // Máscara simples para CPF (visual)
    document.getElementById('ckCpf').addEventListener('input', function(e) {
        let x = e.target.value.replace(/\D/g, '').match(/(\d{0,3})(\d{0,3})(\d{0,3})(\d{0,2})/);
        e.target.value = !x[2] ? x[1] : x[1] + '.' + x[2] + '.' + x[3] + (x[4] ? '-' + x[4] : '');
    });

</script>

</body>
</html>
