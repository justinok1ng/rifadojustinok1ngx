<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COROLLA XEI 2020</title>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" type="text/css" href="/public/css/main.css">

    <style>
        body { background-color: #161c24; color: #fff; }
        body.modal-travado { overflow:hidden !important; }
        #pageHome.is-hidden { display:none !important; }
        #ckPix, #ckLoading {
            position: fixed !important; inset: 0 !important; width: 100vw !important; height: 100vh !important;
            z-index: 2147483647 !important; background: rgba(0,0,0,.75) !important;
            display: none; align-items: center; justify-content: center;
        }
        #ckPix.is-open, #ckLoading.is-open { display: flex !important; }
        .ck-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,.75); z-index: 2147483647; }
        .ck-overlay.is-open { display: block; }
        .ck-card { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); width: min(720px, 92vw); background: #1a2330; border-radius: 14px; overflow: hidden; color: #e5e7eb; }
        /* Seus outros estilos permanecem os mesmos... */
        .pix-qr-wrap img { width: 200px; background: #fff; padding: 10px; border-radius: 10px; margin-top: 10px; }
    </style>
</head>

<body>
<div id="pageHome">
    <nav style="background-color: #1a1a1a; padding: 15px;">
        <div class="d-flex justify-content-between align-items-center">
            <img src="/public/images/logo.png" style="max-height: 40px;">
            <i class="bi bi-list" style="font-size: 30px;" id="showPopupButton"></i>
        </div>
    </nav>

    <section class="container mt-4">
        <div id="imgSingle" style="height: 300px; border-radius: 15px; background-image: url('/public/images/principal.jpg'); background-size: cover; background-position: center;"></div>
        
        <div class="mt-3">
            <h3>COROLLA XEI 2020</h3>
            <div class="price-single">Por apenas <strong>R$ 0,03</strong></div>
        </div>

        <div class="content-select d-flex flex-wrap gap-2 mt-3">
            <div class="select p-3 border rounded text-center" style="cursor:pointer; flex: 1; min-width: 100px; background: #000;">
                <span>+<h3>100</h3></span>
            </div>
            <div class="select p-3 border rounded text-center" style="cursor:pointer; flex: 1; min-width: 100px; background: #000;">
                <span>+<h3>350</h3></span>
            </div>
            <div class="select p-3 border rounded text-center" style="cursor:pointer; flex: 1; min-width: 100px; background: #000;">
                <span>+<h3>500</h3></span>
            </div>
        </div>

        <div class="add-to-cart mt-4">
            <div class="d-flex align-items-center gap-3 mb-3">
                <i class="bi bi-dash-circle js-qty-minus" style="font-size: 30px; cursor:pointer;"></i>
                <input class="input-quantity form-control text-center" type="number" value="100" style="width: 100px; background: #1f2832; color: #fff;">
                <i class="bi bi-plus-circle-fill js-qty-plus" style="font-size: 30px; cursor:pointer;"></i>
            </div>
            <button class="btn-add-to-cart btn btn-danger w-100 p-3">
                Quero Participar - R$ <span class="price-participate">3,00</span>
            </button>
        </div>
    </section>
</div>

<div id="ckStep1" class="ck-overlay">
    <div class="ck-card p-4">
        <div class="d-flex justify-content-between"><h5>Checkout</h5> <i class="bi bi-x-lg" data-ck-close></i></div>
        <div class="ck-alert blue p-2 mt-2">Adquirindo <b id="ckQty">100</b> unidades</div>
        <input id="ckPhone" class="form-control mt-3" type="tel" placeholder="(DDD) 9XXXX-XXXX">
        <button class="btn btn-danger w-100 mt-3" id="ckGoStep2">Continuar</button>
    </div>
</div>

<div id="ckStep2" class="ck-overlay">
    <div class="ck-card p-4">
        <h5>Confirmar Dados</h5>
        <input id="ckPhoneConfirm" class="form-control mt-2" type="tel" placeholder="Confirme seu telefone">
        <input id="ckName" class="form-control mt-2" type="text" placeholder="Nome Completo">
        <button class="btn btn-danger w-100 mt-3" id="ckGoStep3">Concluir</button>
        <p class="text-center mt-2" id="ckBackTo1" style="cursor:pointer; color: red;">Voltar</p>
    </div>
</div>

<div id="ckLoading">
    <div class="text-center text-white">
        <div class="spinner-border text-danger"></div>
        <p class="mt-2">Gerando seu PIX...</p>
    </div>
</div>

<div id="ckPix">
    <div class="pix-card p-4 bg-dark text-white text-center">
        <h5>⏳ Pagamento Pendente</h5>
        <p>Total: R$ <span id="pixTotal">0,00</span></p>
        <div class="bg-light p-2 text-dark rounded mb-3" id="pixCopyPaste" style="word-break: break-all; font-size: 10px;">---</div>
        <button class="btn btn-primary w-100 mb-2" id="pixCopyBtn">COPIAR CÓDIGO PIX</button>
        <div id="pixQrWrap" style="display:none;"><img id="pixQrImg"></div>
        <button class="btn btn-outline-light btn-sm w-100" id="pixToggleBtn">Mostrar QR Code</button>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function(){
    const unitPrice = 0.03;
    const inputQty = document.querySelector('.input-quantity');
    const priceEl = document.querySelector('.price-participate');

    // Função de atualizar preço
    function updatePrice() {
        let q = parseInt(inputQty.value) || 1;
        priceEl.innerText = (q * unitPrice).toFixed(2).replace('.', ',');
    }

    // Botões + e -
    document.querySelector('.js-qty-minus').onclick = () => { if(inputQty.value > 1) inputQty.value--; updatePrice(); };
    document.querySelector('.js-qty-plus').onclick = () => { inputQty.value++; updatePrice(); };
    inputQty.oninput = updatePrice;

    // Seleção rápida
    document.querySelectorAll('.select').forEach(sel => {
        sel.onclick = () => {
            inputQty.value = sel.querySelector('h3').innerText;
            updatePrice();
        };
    });

    // Fluxo Modais
    const open = (id) => document.getElementById(id).classList.add('is-open');
    const closeAll = () => document.querySelectorAll('.ck-overlay, #ckPix, #ckLoading').forEach(el => el.classList.remove('is-open'));

    document.querySelector('.btn-add-to-cart').onclick = () => {
        document.getElementById('ckQty').innerText = inputQty.value;
        open('ckStep1');
    };

    document.querySelectorAll('[data-ck-close]').forEach(b => b.onclick = closeAll);

    document.getElementById('ckGoStep2').onclick = () => {
        if(document.getElementById('ckPhone').value.length < 10) return alert('Telefone inválido');
        closeAll(); open('ckStep2');
    };

    document.getElementById('ckGoStep3').onclick = async () => {
        const nome = document.getElementById('ckName').value;
        const f1 = document.getElementById('ckPhone').value;
        const f2 = document.getElementById('ckPhoneConfirm').value;

        if(f1 !== f2) return alert('Os telefones não conferem');
        if(!nome) return alert('Digite seu nome');

        closeAll();
        document.getElementById('ckLoading').classList.add('is-open');

        try {
            const res = await fetch('/api/pix', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    amount: +(parseInt(inputQty.value) * unitPrice).toFixed(2),
                    buyerName: nome,
                    buyerPhone: f1,
                    qty: parseInt(inputQty.value)
                })
            });

            const data = await res.json();
            document.getElementById('ckLoading').classList.remove('is-open');

            if(res.ok) {
                document.getElementById('pixCopyPaste').innerText = data.copiaecola;
                document.getElementById('pixTotal').innerText = (parseInt(inputQty.value) * unitPrice).toFixed(2).replace('.',',');
                if(data.qrCodeBase64) document.getElementById('pixQrImg').src = "data:image/png;base64," + data.qrCodeBase64;
                document.getElementById('pageHome').classList.add('is-hidden');
                document.getElementById('ckPix').classList.add('is-open');
            } else {
                alert('Erro: ' + data.error);
                document.getElementById('pageHome').classList.remove('is-hidden');
            }
        } catch (e) {
            alert('Erro ao conectar com servidor');
            document.getElementById('ckLoading').classList.remove('is-open');
        }
    };

    // Copiar PIX
    document.getElementById('pixCopyBtn').onclick = function() {
        navigator.clipboard.writeText(document.getElementById('pixCopyPaste').innerText);
        this.innerText = "COPIADO!";
        setTimeout(() => this.innerText = "COPIAR CÓDIGO PIX", 2000);
    };

    document.getElementById('pixToggleBtn').onclick = function() {
        const wrap = document.getElementById('pixQrWrap');
        wrap.style.display = wrap.style.display === 'none' ? 'block' : 'none';
    };
});
</script>
</body>
</html>
