<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COROLLA XEI 2020</title>
    
    <meta name="description" content="Filantropia premiável.">
    <meta name="keywords" content="Campanha, Rifa, Ação entre amigos, Prêmio">
    <meta name="robots" content="index, follow">

    <meta property="og:title" content="ROLETAS PREMIADAS">
    <meta property="og:description" content="Sua chance de mudar de vida chegou!">
    <meta property="og:image" content="/public/images/principal.jpg">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="Sorteios Online">

    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <link rel="stylesheet" type="text/css" href="/public/css/main.css">

    <style>
        /* CSS de Emergência */
        body { background-color: #161c24; color: #fff; }
        body.modal-travado { overflow:hidden !important; }
        #pageHome.is-hidden { display:none !important; }

        /* PIX e LOADING */
        #ckPix, #ckLoading {
            position: fixed !important; inset: 0 !important; width: 100vw !important; height: 100vh !important;
            z-index: 2147483647 !important; background: rgba(0,0,0,.75) !important;
            opacity: 0; pointer-events: none; transition: opacity .25s ease; display: none;
        }
        #ckPix.is-open, #ckLoading.is-open { opacity: 1; pointer-events: auto; display: block !important; }

        /* Estilos Gerais */
        .cs-box { background: #1f2832; border: 1px solid rgba(255,255,255,.08); border-radius: 12px; padding: 10px; color: #fff; font-family: system-ui, -apple-system, sans-serif; max-width: 560px; margin: 0 auto; }
        .cs-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .cs-title { display: flex; gap: 8px; font-weight: 800; font-size: 14px; }
        .cs-badge { background: #10161d; border: 1px solid rgba(255,255,255,.12); color: #ff3b3b; font-weight: 900; font-size: 11px; padding: 2px 7px; border-radius: 9px; }
        .cs-list { display: flex; flex-direction: column; gap: 6px; }
        .cs-row { background: #161c24; border: 1px solid rgba(255,255,255,.08); border-radius: 10px; padding: 6px 10px; display: flex; align-items: center; justify-content: space-between; min-height: 30px; }
        .cs-row.winner { background: #ff3b3b; border: none; }
        .cs-pill { display: inline-flex; align-items: center; gap: 6px; background: #919eab; padding: 2px 8px; border-radius: 9px; font-weight: 900; font-size: 11px; color: #ffffff; }
        .cs-row.winner .cs-pill { background: #ffffff; border: 2px solid #ff3b3b; color: #0b0f14; }
        .cs-more-btn { margin-top: 8px; width: 100%; background: transparent; border: none; color: #ff3b3b; font-weight: 900; font-size: 11px; cursor: pointer; padding: 6px 0; }
        .cs-row.is-hidden { display: none; }

        /* Checkout Styles */
        .ck-overlay { display: none; position: fixed; inset: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,.75); z-index: 2147483647; }
        .ck-overlay.is-open { display: block; }
        .ck-card { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); width: min(720px, 92vw); background: #1a2330; border: 1px solid rgba(255,255,255,.08); border-radius: 14px; box-shadow: 0 18px 60px rgba(0,0,0,.75); overflow: hidden; font-family: system-ui, sans-serif; color: #e5e7eb; }
        .ck-header { display: flex; align-items: center; justify-content: space-between; padding: 14px 16px; background: #1f2a38; border-bottom: 1px solid rgba(255,255,255,.07); font-weight: 900; }
        .ck-close { background: transparent; border: none; color: rgba(255,255,255,.65); font-size: 22px; cursor: pointer; }
        .ck-body { padding: 14px 16px 16px; }
        .ck-alert { display: flex; align-items: center; gap: 10px; border-radius: 10px; padding: 12px; font-size: 13px; margin-bottom: 12px; }
        .ck-alert.blue { background: #133b78; color: #e6f0ff; }
        .ck-alert.yellow { background: #7b5a00; color: #fff; }
        .ck-alert.green { background: #0f6a3b; color: #fff; }
        .ck-row { display: flex; align-items: center; gap: 10px; background: #0f1722; border: 1px solid rgba(255,255,255,.10); border-radius: 10px; padding: 10px 12px; margin-bottom: 10px; }
        .ck-input { width: 100%; border: none; outline: none; background: transparent; color: #fff; font-size: 14px; }
        .ck-btn { width: 100%; border: none; cursor: pointer; background: #ff3b3b; color: #fff; font-weight: 900; padding: 14px; border-radius: 10px; }

        /* Pix Card */
        .pix-card { width: min(720px, 92vw); margin: 20px auto 60px; background: #1a2330; border-radius: 14px; overflow: hidden; }
        .pix-header { padding: 16px; background: #1f2a38; color: #fff; font-weight: 900; }
        .pix-body { padding: 16px; }
        .pix-code-row { display: flex; gap: 10px; align-items: center; background: #0f1722; padding: 10px; margin: 12px 0; border-radius: 10px; }
        .pix-code { flex: 1; font-family: monospace; font-size: 12px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .pix-copy { border: none; background: #ff3b3b; color: #fff; padding: 10px 12px; border-radius: 10px; cursor: pointer; font-weight: bold; }
        .pix-qr-wrap { text-align: center; margin-top: 12px; display: none; }
        .pix-qr-wrap img { width: 200px; background: #fff; padding: 10px; border-radius: 10px; }
    </style>
</head>

<body>
<div id="pageHome">
    <nav style="background-color: #1a1a1a;">
        <div class="container d-flex justify-content-between align-items-center py-2">
            <a href="/"><img src="/public/images/logo.png" style="max-height: 40px;"></a>
            <img src="/public/images/menu.svg" width="30px" id="showPopupButton" style="cursor:pointer">
        </div>
    </nav>

    <section class="container mt-4">
        <div class="info-single text-center">
            <div id="imgSingle" style="height: 300px; background-image: url('/public/images/principal.jpg'); background-size: cover; background-position: center; border-radius: 12px;"></div>
            
            <div class="py-3">
                <h3>COROLLA XEI 2020</h3>
                <p>Por apenas <span style="background:#1a1a1a; padding: 5px 10px; border-radius: 8px;">R$ 0,03</span></p>
            </div>

            <div class="select-single">
                <p class="small text-muted">Quanto mais títulos, mais chances de ganhar!</p>
                <div class="d-flex flex-wrap justify-content-center gap-2 mb-4">
                    <div class="select p-3 bg-dark rounded border" style="cursor:pointer; min-width: 100px;">
                        <span>+<h3>100</h3></span>
                        <p class="small mb-0">SELECIONAR</p>
                    </div>
                    <div class="select p-3 bg-dark rounded border border-danger" style="cursor:pointer; min-width: 100px;">
                        <button class="btn btn-danger btn-sm mb-1" style="font-size: 10px;">Mais popular</button>
                        <span>+<h3>350</h3></span>
                        <p class="small mb-0">SELECIONAR</p>
                    </div>
                    <div class="select p-3 bg-dark rounded border" style="cursor:pointer; min-width: 100px;">
                        <span>+<h3>1000</h3></span>
                        <p class="small mb-0">SELECIONAR</p>
                    </div>
                </div>

                <div class="add-to-cart d-flex align-items-center justify-content-center gap-3 mb-5">
                    <div class="d-flex align-items-center bg-dark rounded p-2 border">
                        <i class="bi bi-dash-circle js-qty-minus px-2" style="cursor:pointer"></i>
                        <input class="input-quantity text-center bg-transparent border-0 text-white" type="number" value="100" style="width: 60px;">
                        <i class="bi bi-plus-circle-fill js-qty-plus px-2" style="cursor:pointer"></i>
                    </div>
                    <button type="button" class="btn-add-to-cart btn btn-danger py-3 px-4">
                        <i class="bi bi-check-circle mr-2"></i>
                        Quero Participar - R$ <span class="price-participate">3,00</span>
                    </button>
                </div>
            </div>
        </div>
    </section>
</div>

<div id="ckStep1" class="ck-overlay">
  <div class="ck-card">
    <div class="ck-header">
        <span>Checkout</span>
        <button class="ck-close" data-ck-close><i class="bi bi-x-lg"></i></button>
    </div>
    <div class="ck-body">
      <div class="ck-alert blue">
        <div>Você está adquirindo <b id="ckQty">100</b> unidades de <b id="ckProduct">ROLETAS PREMIADAS</b></div>
      </div>
      <div class="ck-label">Informe seu telefone *</div>
      <div class="ck-row">
        <input id="ckPhone" class="ck-input" type="tel" placeholder="(DDD) 9XXXX-XXXX">
      </div>
      <button class="ck-btn mt-3" id="ckGoStep2">Concluir Reserva</button>
    </div>
  </div>
</div>

<div id="ckStep2" class="ck-overlay">
  <div class="ck-card">
    <div class="ck-header">
        <span>Confirmar Dados</span>
        <button class="ck-close" data-ck-close><i class="bi bi-x-lg"></i></button>
    </div>
    <div class="ck-body">
      <div class="ck-label">Repita o telefone *</div>
      <div class="ck-row">
         <input id="ckPhoneConfirm" class="ck-input" type="tel" placeholder="Confirme seu número">
      </div>
      <div class="ck-label">Nome Completo *</div>
      <div class="ck-row">
        <input id="ckName" class="ck-input" type="text" placeholder="Seu nome completo">
      </div>
      <button class="ck-btn mt-3" id="ckGoStep3">Concluir Reserva</button>
    </div>
  </div>
</div>

<div id="ckStep3" class="ck-overlay">
  <div class="ck-card">
    <div class="ck-header">
        <span>Resumo do Pedido</span>
        <button class="ck-close" data-ck-close><i class="bi bi-x-lg"></i></button>
    </div>
    <div class="ck-body">
      <div class="ck-alert green">
        <div>Tudo pronto! Confira seus dados:</div>
      </div>
      <div class="bg-dark p-3 rounded">
          <div id="ckNameShow" class="font-weight-bold"></div>
          <div id="ckPhoneShow" class="small text-muted"></div>
      </div>
      <button class="ck-btn mt-3" id="ckCreatePayment">Gerar PIX de Pagamento</button>
    </div>
  </div>
</div>

<div id="ckLoading">
    <div class="ck-loading-wrap text-center">
        <div class="spinner-border text-danger mb-3"></div>
        <div class="h5">Processando seu PIX...</div>
    </div>
</div>

<div id="ckPix">
  <div class="pix-card">
    <div class="pix-header">⏳ Aguardando Pagamento</div>
    <div class="pix-body">
      <p class="text-center">Copie o código abaixo e pague no seu banco:</p>
      <div class="pix-code-row">
        <div id="pixCopyPaste" class="pix-code">GERANDO...</div>
        <button class="pix-copy" id="pixCopyBtn">COPIAR</button>
      </div>
      <div class="text-center mt-3">
          <button class="btn btn-outline-light btn-sm" id="pixToggleBtn">Ver QR Code</button>
          <div class="pix-qr-wrap" id="pixQrWrap">
              <img id="pixQrImg" src="">
          </div>
      </div>
      <div class="bg-dark p-3 mt-4 rounded">
          <div><b>Total:</b> R$ <span id="pixTotal">0,00</span></div>
          <div><b>Comprador:</b> <span id="pixBuyer"></span></div>
      </div>
    </div>
  </div>
</div>

<script>
window.addEventListener('load', function() {
    const unitPrice = 0.03;
    const inputQty = document.querySelector('.input-quantity');
    const priceDisplay = document.querySelector('.price-participate');

    function refreshTotals() {
        if (!inputQty || !priceDisplay) return;
        let q = parseInt(inputQty.value) || 1;
        if (q < 1) q = 1;
        inputQty.value = q;
        priceDisplay.innerText = (q * unitPrice).toFixed(2).replace('.', ',');
        
        ['ckQty', 'ckQty2', 'ckQty3'].forEach(id => {
            const el = document.getElementById(id);
            if(el) el.innerText = q;
        });
    }

    document.addEventListener('click', function(e) {
        const t = e.target;

        if (t.closest('.btn-add-to-cart')) {
            e.preventDefault();
            refreshTotals();
            document.getElementById('ckStep1').classList.add('is-open');
            document.body.classList.add('modal-travado');
        }

        if (t.closest('[data-ck-close]')) {
            document.querySelectorAll('.ck-overlay, #ckPix, #ckLoading').forEach(m => {
                m.classList.remove('is-open');
                m.style.display = 'none';
            });
            document.body.classList.remove('modal-travado');
        }

        const sel = t.closest('.select');
        if (sel) {
            const h3 = sel.querySelector('h3');
            if(h3) {
                inputQty.value = h3.innerText;
                refreshTotals();
            }
        }

        if (t.classList.contains('js-qty-plus')) { inputQty.value++; refreshTotals(); }
        if (t.classList.contains('js-qty-minus')) { if(inputQty.value > 1) inputQty.value--; refreshTotals(); }

        if (t.id === 'ckGoStep2') {
            const phone = document.getElementById('ckPhone').value;
            if(phone.length < 10) return alert("Digite um telefone válido");
            document.getElementById('ckStep1').classList.remove('is-open');
            document.getElementById('ckStep2').classList.add('is-open');
        }

        if (t.id === 'ckGoStep3') {
            const nome = document.getElementById('ckName').value;
            const p1 = document.getElementById('ckPhone').value;
            const p2 = document.getElementById('ckPhoneConfirm').value;
            if(nome.length < 3) return alert("Nome completo obrigatório");
            if(p1 !== p2) return alert("Os telefones não coincidem");
            
            document.getElementById('ckNameShow').innerText = nome;
            document.getElementById('ckPhoneShow').innerText = p1;
            document.getElementById('ckStep2').classList.remove('is-open');
            document.getElementById('ckStep3').classList.add('is-open');
        }

        if (t.id === 'ckCreatePayment') {
            handlePixGeneration();
        }

        if (t.id === 'pixCopyBtn') {
            const code = document.getElementById('pixCopyPaste').innerText;
            navigator.clipboard.writeText(code);
            t.innerText = "COPIADO!";
            setTimeout(() => t.innerText = "COPIAR", 2000);
        }

        if (t.id === 'pixToggleBtn') {
            const qr = document.getElementById('pixQrWrap');
            qr.style.display = qr.style.display === 'block' ? 'none' : 'block';
        }
    });

    async function handlePixGeneration() {
        document.getElementById('ckStep3').classList.remove('is-open');
        document.getElementById('ckLoading').classList.add('is-open');

        const qty = parseInt(inputQty.value);
        const payload = {
            amount: +(qty * unitPrice).toFixed(2),
            buyerName: document.getElementById('ckName').value,
            buyerPhone: document.getElementById('ckPhone').value,
            qty: qty
        };

        try {
            const res = await fetch('/api/pix', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const data = await res.json();
            document.getElementById('ckLoading').classList.remove('is-open');

            if (res.ok) {
                document.getElementById('pixCopyPaste').innerText = data.copiaecola;
                document.getElementById('pixTotal').innerText = payload.amount.toString().replace('.', ',');
                document.getElementById('pixBuyer').innerText = payload.buyerName;
                if(data.qrCodeBase64) document.getElementById('pixQrImg').src = "data:image/png;base64," + data.qrCodeBase64;
                
                document.getElementById('pageHome').style.display = 'none';
                document.getElementById('ckPix').classList.add('is-open');
            } else {
                alert("Erro: " + data.error);
                document.getElementById('pageHome').style.display = 'block';
            }
        } catch (err) {
            document.getElementById('ckLoading').classList.remove('is-open');
            alert("Erro de conexão com o servidor.");
        }
    }

    refreshTotals();
});
</script>
</body>
</html>
